<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopify OAuth Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button { background: #007cba; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #005a87; }
        input { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>üîê Shopify OAuth Flow Test</h1>
    
    <div class="test-section">
        <h3>1. App Configuration</h3>
        <p><strong>API Key:</strong> <code>cc1aedf4a961513c70b6953dc5256345</code></p>
        <p><strong>Server URL:</strong> <code>https://esnd-credit-check-api.onrender.com</code></p>
        <p><strong>Status:</strong> <span id="serverStatus">Checking...</span></p>
        <button onclick="checkServerStatus()">Check Server Status</button>
    </div>

    <div class="test-section">
        <h3>2. OAuth Test</h3>
        <label for="shopDomain">Shop Domain:</label>
        <input type="text" id="shopDomain" placeholder="your-store.myshopify.com" value="everythingsafetynd.myshopify.com">
        <button onclick="testOAuth()">Test OAuth Flow</button>
        <div id="oauthResult"></div>
    </div>

    <div class="test-section">
        <h3>3. Credit Check Test</h3>
        <label for="customerId">Customer ID:</label>
        <input type="text" id="customerId" placeholder="Enter customer ID" value="0698ab21-5fa1-11f0-f6d9-7927451b268f">
        <label for="purchaseOrder">Purchase Order:</label>
        <input type="text" id="purchaseOrder" placeholder="Enter PO number" value="PO123456789">
        <button onclick="testCreditCheck()">Test Credit Check</button>
        <div id="creditCheckResult"></div>
    </div>

    <div class="test-section">
        <h3>4. Test Logs</h3>
        <div id="testLogs" class="log"></div>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <script>
        const appUrl = 'https://esnd-credit-check-api.onrender.com';
        
        function log(message, type = 'info') {
            const logs = document.getElementById('testLogs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }

        function clearLogs() {
            document.getElementById('testLogs').innerHTML = '';
        }

        async function checkServerStatus() {
            const statusSpan = document.getElementById('serverStatus');
            statusSpan.textContent = 'Checking...';
            
            try {
                const response = await fetch(appUrl);
                if (response.ok) {
                    statusSpan.textContent = '‚úÖ Online';
                    statusSpan.className = 'success';
                    log('Server is online and responding', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                statusSpan.textContent = '‚ùå Offline';
                statusSpan.className = 'error';
                log(`Server check failed: ${error.message}`, 'error');
            }
        }

        function testOAuth() {
            const shop = document.getElementById('shopDomain').value.trim();
            if (!shop) {
                alert('Please enter a shop domain');
                return;
            }

            const authUrl = `${appUrl}/auth?shop=${shop}`;
            log(`Initiating OAuth flow to: ${authUrl}`, 'info');
            
            // Open OAuth in new window
            const authWindow = window.open(authUrl, 'shopify_oauth', 'width=600,height=600');
            
            // Check for OAuth completion
            const checkAuth = setInterval(() => {
                try {
                    if (authWindow.closed) {
                        clearInterval(checkAuth);
                        log('OAuth window closed - check if authentication was successful', 'info');
                        
                        // Check if we have access token in localStorage
                        const token = localStorage.getItem('shopifyAccessToken');
                        if (token) {
                            log('‚úÖ Access token found in localStorage', 'success');
                            document.getElementById('oauthResult').innerHTML = '<div class="success">‚úÖ OAuth successful! Access token stored.</div>';
                        } else {
                            log('‚ùå No access token found', 'error');
                            document.getElementById('oauthResult').innerHTML = '<div class="error">‚ùå OAuth failed or incomplete</div>';
                        }
                    }
                } catch (e) {
                    // Window might be closed
                }
            }, 1000);
        }

        async function testCreditCheck() {
            const customerId = document.getElementById('customerId').value.trim();
            const purchaseOrder = document.getElementById('purchaseOrder').value.trim();
            
            if (!customerId || !purchaseOrder) {
                alert('Please fill in all fields');
                return;
            }

            log(`Testing credit check for customer: ${customerId}, PO: ${purchaseOrder}`, 'info');
            
            try {
                log(`Making request to: ${appUrl}/proxy/creditCheck`, 'info');
                
                const response = await fetch(`${appUrl}/proxy/creditCheck`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customer_id: customerId,
                        purchase_order: purchaseOrder
                    })
                });

                log(`Response status: ${response.status}`, 'info');
                log(`Response headers: ${JSON.stringify([...response.headers.entries()])}`, 'info');

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`Error response body: ${errorText}`, 'error');
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                log(`Credit check response: ${JSON.stringify(data, null, 2)}`, 'success');
                
                if (data.ok && data.credit_check && data.credit_check.status === 'success') {
                    document.getElementById('creditCheckResult').innerHTML = `
                        <div class="success">
                            ‚úÖ Credit check successful!<br>
                            Available credit: $${data.credit_check.credit}<br>
                            Status: ${data.credit_check.status}
                        </div>
                    `;
                } else {
                    document.getElementById('creditCheckResult').innerHTML = `
                        <div class="error">
                            ‚ùå Credit check failed: ${data.error || 'Unknown error'}
                        </div>
                    `;
                }
                
            } catch (error) {
                log(`Credit check failed: ${error.message}`, 'error');
                log(`Full error: ${error.stack}`, 'error');
                document.getElementById('creditCheckResult').innerHTML = `
                    <div class="error">
                        ‚ùå Credit check failed: ${error.message}<br>
                        <small>Check console for more details</small>
                    </div>
                `;
            }
        }

        // Auto-check server status on load
        window.addEventListener('load', checkServerStatus);
        
        // Check for OAuth callback parameters
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const accessToken = urlParams.get('access_token');
            const shop = urlParams.get('shop');
            
            if (accessToken && shop) {
                log(`OAuth callback detected - Shop: ${shop}, Token: ${accessToken.substring(0, 20)}...`, 'success');
                
                // Store token
                localStorage.setItem('shopifyAccessToken', accessToken);
                
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // Update OAuth result
                document.getElementById('oauthResult').innerHTML = `
                    <div class="success">
                        ‚úÖ OAuth successful!<br>
                        Shop: ${shop}<br>
                        Access token stored
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
