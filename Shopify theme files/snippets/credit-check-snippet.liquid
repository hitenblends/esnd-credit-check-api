{% comment %}
  Credit Check API Snippet
  Add this to your Shopify theme to test the credit check API
  Usage: {% render 'credit-check-snippet' %}
{% endcomment %}

<div class="credit-check-container" style="max-width: 600px; margin: 30px auto; padding: 20px; background: #f8f9fa; border-radius: 12px;">
  
  <h2 style="text-align: center; color: #2c3e50; margin-bottom: 25px;">üîç Credit Check System</h2>
  
  <form id="creditCheckForm" style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    
    <div class="form-group" style="margin-bottom: 20px;">
      <label for="customer_id" style="display: block; margin-bottom: 8px; font-weight: 600; color: #34495e;">
        Customer ID (Lightspeed UUID):
      </label>
      <input type="text" 
             id="customer_id" 
             name="customer_id" 
             placeholder="e.g., 123e4567-e89b-12d3-a456-426614174000" 
             required
             style="width: 100%; padding: 12px; border: 2px solid #e1e8ed; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
    </div>
    
    <div class="form-group" style="margin-bottom: 20px;">
      <label for="purchase_order" style="display: block; margin-bottom: 8px; font-weight: 600; color: #34495e;">
        Purchase Order ID:
      </label>
      <input type="text" 
             id="purchase_order" 
             name="purchase_order" 
             placeholder="e.g., PO-2024-001" 
             required
             style="width: 100%; padding: 12px; border: 2px solid #e1e8ed; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
    </div>
    
    <div class="form-group" style="margin-bottom: 20px;">
      <label for="check_date" style="display: block; margin-bottom: 8px; font-weight: 600; color: #34495e;">
        Check Date:
      </label>
      <input type="date" 
             id="check_date" 
             name="check_date" 
             required
             style="width: 100%; padding: 12px; border: 2px solid #e1e8ed; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
    </div>
    
    <button type="submit" 
            id="submitBtn" 
            style="background: #007bff; color: white; border: none; padding: 14px 28px; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; transition: background-color 0.3s;">
      Run Credit Check
    </button>
  </form>
  
  <!-- Loading State -->
  <div id="loadingState" style="display: none; text-align: center; margin: 20px 0; color: #6c757d;">
    <div style="font-size: 18px; margin-bottom: 10px;">‚è≥ Processing Credit Check...</div>
    <div style="font-size: 14px;">Please wait while we verify the information...</div>
  </div>
  
  <!-- Results Display -->
  <div id="resultDisplay" style="display: none; margin-top: 25px;"></div>
  
</div>

<style>
  .credit-check-container input:focus {
    outline: none;
    border-color: #007bff;
  }
  
  .credit-check-container button:hover {
    background: #0056b3 !important;
  }
  
  .credit-check-container button:disabled {
    background: #6c757d !important;
    cursor: not-allowed;
  }
  
  .result-success {
    background: #d4edda !important;
    border: 1px solid #c3e6cb !important;
    color: #155724 !important;
    padding: 20px;
    border-radius: 8px;
    margin-top: 20px;
  }
  
  .result-error {
    background: #f8d7da !important;
    border: 1px solid #f5c6cb !important;
    color: #721c24 !important;
    padding: 20px;
    border-radius: 8px;
    margin-top: 20px;
  }
  
  .result-data {
    background: rgba(0,0,0,0.05);
    padding: 15px;
    border-radius: 6px;
    margin: 15px 0;
    font-family: monospace;
    font-size: 13px;
    overflow-x: auto;
  }
  
  .result-info {
    margin: 10px 0;
    padding: 10px;
    background: rgba(0,0,0,0.03);
    border-radius: 4px;
  }
  
  .result-info strong {
    color: #495057;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('creditCheckForm');
  const submitBtn = document.getElementById('submitBtn');
  const loadingState = document.getElementById('loadingState');
  const resultDisplay = document.getElementById('resultDisplay');
  
  // Set default date to today
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('check_date').value = today;
  
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Get form data
    const customer_id = document.getElementById('customer_id').value;
    const purchase_order = document.getElementById('purchase_order').value;
    const check_date = document.getElementById('check_date').value;
    
    // Validate required fields
    if (!customer_id || !purchase_order || !check_date) {
      showResult('error', 'Please fill in all required fields.');
      return;
    }
    
    // Show loading state
    submitBtn.disabled = true;
    submitBtn.textContent = 'Processing...';
    loadingState.style.display = 'block';
    resultDisplay.style.display = 'none';
    
    try {
      // Make API call to your test endpoint (no Shopify signature required)
      const response = await fetch('https://esnd-credit-check-api.onrender.com/test/creditCheck', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          customer_id: customer_id,
          purchase_order: purchase_order,
          check_date: check_date
        })
      });
      
      const data = await response.json();
      
      if (response.ok) {
        showSuccessResult(data, customer_id, purchase_order, check_date);
      } else {
        showResult('error', `API Error: ${data.error || 'Unknown error'}`, data.details);
      }
      
    } catch (error) {
      showResult('error', 'Network Error', error.message);
    } finally {
      // Reset button state
      submitBtn.disabled = false;
      submitBtn.textContent = 'Run Credit Check';
      loadingState.style.display = 'none';
    }
  });
  
  function showSuccessResult(data, customer_id, purchase_order, check_date) {
    const resultHtml = `
      <div class="result-success">
        <h3 style="margin-top: 0; color: #155724;">‚úÖ Credit Check Completed Successfully!</h3>
        
        <div class="result-info">
          <strong>Customer ID:</strong> ${customer_id}
        </div>
        
        <div class="result-info">
          <strong>Purchase Order:</strong> ${purchase_order}
        </div>
        
        <div class="result-info">
          <strong>Check Date:</strong> ${check_date}
        </div>
        
        <div class="result-info">
          <strong>Timestamp:</strong> ${data.timestamp || 'N/A'}
        </div>
        
        <div style="margin-top: 20px;">
          <strong>API Response:</strong>
          <div class="result-data">${JSON.stringify(data.credit_check, null, 2)}</div>
        </div>
      </div>
    `;
    
    resultDisplay.innerHTML = resultHtml;
    resultDisplay.style.display = 'block';
  }
  
  function showResult(type, message, details = '') {
    const resultHtml = `
      <div class="result-${type}">
        <h3 style="margin-top: 0;">${type === 'error' ? '‚ùå Error' : '‚ÑπÔ∏è Info'}</h3>
        <p>${message}</p>
        ${details ? `<div class="result-data">${details}</div>` : ''}
      </div>
    `;
    
    resultDisplay.innerHTML = resultHtml;
    resultDisplay.style.display = 'block';
  }
});
</script>
